{% extends "base_admin.html" %}

{% block title %}대시보드 | 관리자{% endblock %}
{% block layout_extra_class %}has-footer{% endblock %}

{% block content %}
<!-- ================= 상단 바 ================= -->
<div class="bg-white border rounded-3 px-3 py-2 d-flex align-items-center justify-content-between mb-3" style="min-height:44px;">
  <div class="fw-semibold text-muted">우주정보통신</div>
  <div class="d-flex align-items-center gap-2">
    <span class="badge bg-light text-dark border" id="sessionTimer">60:00</span>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#passwordModal">
      <i class="bi bi-key"></i> 비밀번호 변경</button>
    <button type="button" class="btn btn-sm btn-danger" id="btnExtend">연장/업그레이드</button>
    <a href="{{ url_for('admin_logout') }}" class="btn btn-sm btn-secondary">나가기</a>
  </div>
</div>

<!-- ================= 일정관리 + 오늘의 할 일 ================= -->
<div class="row g-3">
  <!-- 일정관리 -->
  <div class="col-12 col-lg-8">
    <div class="card" style="height: 450px;">
      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <div class="fw-semibold">일정관리</div>

        <!-- 가운데 연/월 표시 -->
        <div class="flex-grow-1 text-center">
          <span id="current-date" class="fw-bold fs-6 text-white" style="cursor:pointer;" title="클릭하여 월/연도 이동"></span>
        </div>

        <!-- 버튼 -->
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-secondary" onclick="postCalendarNav('today')">today</button>
          <button class="btn btn-sm btn-dark" onclick="postCalendarNav('prev')">&lt;</button>
          <button class="btn btn-sm btn-dark" onclick="postCalendarNav('next')">&gt;</button>
        </div>
      </div>

      <!-- iframe (FullCalendar 페이지 포함) -->
      <div class="card-body p-0">
        <iframe id="calendarIframe" src="/calendar" style="width:100%;height:100%;border:none;"></iframe>
      </div>
    </div>
  </div>

  <!-- 오늘의 할 일 -->
  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-header bg-secondary text-white d-flex align-items-center justify-content-between">
        <span>오늘의 할 일</span>
        <div class="small">
          <span class="badge bg-light text-dark"><span id="todo-count-active">0</span> 진행</span>
          <span class="badge bg-dark ms-1"><span id="todo-count-total">0</span> 전체</span>
        </div>
      </div>

      <div class="card-body">
        <!-- 입력 -->
        <form id="todo-form" class="mb-3" autocomplete="off">
          <div class="input-group">
            <input id="todo-input" type="text" class="form-control" placeholder="할 일을 입력하고 Enter">
            <button class="btn btn-primary" type="submit"><i class="bi bi-plus-lg"></i></button>
          </div>
          <div class="form-text">Enter로 추가, 항목 클릭 시 완료 처리됩니다.</div>
        </form>

        <!-- 필터 -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="btn-group btn-group-sm" role="group" aria-label="filter">
            <button type="button" class="btn btn-outline-secondary active" data-filter="all">전체</button>
            <button type="button" class="btn btn-outline-secondary" data-filter="active">진행</button>
            <button type="button" class="btn btn-outline-secondary" data-filter="done">완료</button>
          </div>
          <div class="d-flex gap-2">
            <button id="btn-clear-done" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-check2-all me-1"></i>완료 비우기
            </button>
            <button id="btn-clear-all" class="btn btn-sm btn-outline-danger">
              <i class="bi bi-trash3 me-1"></i>전체 삭제
            </button>
          </div>
        </div>

        <!-- 목록 -->
        <ul id="todo-list" class="list-group list-group-flush"></ul>
      </div>
    </div>
  </div>
</div>

<!-- ================= 캘린더 연동 ================= -->
<script>
function postCalendarNav(command) {
  const iframe = document.getElementById("calendarIframe");
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage({ type: "calendarNav", command }, "*");
  }
}

// 부모(이 페이지) ← 자식(calendar.html)
window.addEventListener("message", (event) => {
  if (event.data && event.data.type === "updateCurrentDate") {
    document.getElementById("current-date").textContent = event.data.dateText || "";
  }
});

// 중앙 연도/월 클릭 시 → 자식(calendar.html)에 openPicker 전송
document.addEventListener("DOMContentLoaded", () => {
  const dateText = document.getElementById("current-date");
  if (dateText) {
    dateText.addEventListener("click", () => {
      const iframe = document.getElementById("calendarIframe");
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ type: "openPicker" }, "*");
      }
    });
  }
});
</script>

<!-- ================= 오늘의 할 일 ================= -->
<script>
let filter = "all";
async function loadTodos() {
  const res = await fetch("/todos");
  const todos = await res.json();
  renderTodoList(todos);
}

function renderTodoList(todos) {
  const list = document.getElementById("todo-list");
  const activeCountEl = document.getElementById("todo-count-active");
  const totalCountEl = document.getElementById("todo-count-total");

  let filtered = todos;
  if (filter === "active") filtered = todos.filter(t => t.status === "진행");
  if (filter === "done") filtered = todos.filter(t => t.status === "완료");

  list.innerHTML = "";
  if (filtered.length === 0) {
    list.innerHTML = `<li class="list-group-item text-center text-muted py-3">할 일이 없습니다.</li>`;
  } else {
    filtered.forEach(todo => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input" ${todo.status === "완료" ? "checked" : ""}
            onchange="toggleTodo(${todo.id}, '${todo.status}')">
          <span class="${todo.status === '완료' ? 'text-decoration-line-through text-muted' : ''}"
                style="cursor:pointer">${todo.content}</span>
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteTodo(${todo.id})">
          <i class="bi bi-x-lg"></i>
        </button>`;
      list.appendChild(li);
    });
  }

  const active = todos.filter(t => t.status === "진행").length;
  activeCountEl.textContent = active;
  totalCountEl.textContent = todos.length;
}

async function addTodo(content) {
  if (!content.trim()) return;
  await fetch("/todos/add", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({content})
  });
  await loadTodos();
}

async function toggleTodo(id, currentStatus) {
  const newStatus = currentStatus === "완료" ? "진행" : "완료";
  await fetch(`/todos/update/${id}`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({status: newStatus})
  });
  await loadTodos();
}

async function deleteTodo(id) {
  await fetch(`/todos/update/${id}`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({status: "삭제"})
  });
  await fetch(`/todos/delete_all`, {method: "POST"});
  await loadTodos();
}

async function clearDone() {
  const res = await fetch("/todos");
  const todos = await res.json();
  for (const t of todos.filter(t => t.status === "완료")) {
    await fetch(`/todos/update/${t.id}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({status: "삭제"})
    });
  }
  await fetch(`/todos/delete_all`, {method: "POST"});
  await loadTodos();
}

async function clearAll() {
  if (!confirm("모든 할 일을 삭제하시겠습니까?")) return;
  await fetch("/todos/delete_all", {method: "POST"});
  await loadTodos();
}

document.getElementById("todo-form").addEventListener("submit", e => {
  e.preventDefault();
  const input = document.getElementById("todo-input");
  addTodo(input.value);
  input.value = "";
});

document.querySelectorAll("[data-filter]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("[data-filter]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    filter = btn.getAttribute("data-filter");
    loadTodos();
  });
});

document.getElementById("btn-clear-done").addEventListener("click", clearDone);
document.getElementById("btn-clear-all").addEventListener("click", clearAll);

loadTodos();
</script>

<!-- ================= 장비 현황 + 공지사항 ================= -->
<div class="row g-3 mt-1">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-info text-white">장비 현황</div>
      <div class="card-body">
        <p class="mb-0 text-muted">여기에 장비 현황 차트(Pie chart 등)를 넣을 수 있습니다.</p>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        공지사항
        <a href="{{ url_for('admin_board_type', board_type='all') }}" class="btn btn-sm btn-outline-light">더보기</a>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:30%;">날짜</th>
              <th>제목</th>
            </tr>
          </thead>
          <tbody>
          {% if posts and posts|length > 0 %}
            {% for p in posts %}
              <tr>
                <td>{{ (p.created_at|default(''))[:10] }}</td>
                <td><a href="{{ url_for('view_board_post', post_id=p.id) }}">{{ p.title }}</a></td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="2" class="text-center text-muted">등록된 공지사항이 없습니다.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ================= 비밀번호 변경 모달 ================= -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('change_password') }}">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="passwordModalLabel"><i class="bi bi-key me-2"></i>비밀번호 변경</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">기존 비밀번호</label>
            <input type="password" class="form-control" name="current_password" required>
          </div>
          <div class="mb-3">
            <label class="form-label">새 비밀번호</label>
            <input type="password" class="form-control" name="new_password" required>
          </div>
          <div class="mb-3">
            <label class="form-label">새 비밀번호 확인</label>
            <input type="password" class="form-control" name="confirm_password" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">변경</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================= 세션 타이머 ================= -->
<script>
(function () {
  const IDLE_MINUTES = 60;
  const LIMIT_MS = IDLE_MINUTES * 60 * 1000;
  const STORAGE_KEY = "admin.lastActivityAt";
  const timerEl = document.getElementById("sessionTimer");
  const logoutURL = "{{ url_for('admin_logout') }}";
  if (!timerEl) return;

  const now = () => Date.now();

  function getLastActivity() {
    const v = parseInt(localStorage.getItem(STORAGE_KEY) || "0", 10);
    if (!v) {
      const t = now();
      localStorage.setItem(STORAGE_KEY, String(t));
      return t;
    }
    return v;
  }
  function setLastActivity(ts = now()) { localStorage.setItem(STORAGE_KEY, String(ts)); }
  function formatMMSS(ms) {
    if (ms < 0) ms = 0;
    const mm = Math.floor(ms / 60000);
    const ss = Math.floor((ms % 60000) / 1000);
    return String(mm).padStart(2, "0") + ":" + String(ss).padStart(2, "0");
  }
  function doLogout() {
    clearInterval(tickId);
    timerEl.textContent = "00:00";
    window.location.href = logoutURL;
  }
  function updateTimer() {
    const remain = LIMIT_MS - (now() - getLastActivity());
    if (remain <= 0) doLogout();
    else timerEl.textContent = formatMMSS(remain);
  }

  let lastResetAt = 0;
  function resetOnActivity() {
    const t = now();
    if (t - lastResetAt < 800) return;
    lastResetAt = t;
    setLastActivity(t);
    updateTimer();
  }

  ["click","keydown","mousemove","wheel","scroll","touchstart","touchmove","pointerdown","visibilitychange"]
    .forEach(evt => document.addEventListener(evt, resetOnActivity, { passive: true }));

  const extendBtn = document.getElementById("btnExtend");
  if (extendBtn) extendBtn.addEventListener("click", resetOnActivity);

  window.addEventListener("storage", (e) => {
    if (e.key === STORAGE_KEY) updateTimer();
  });

  setLastActivity(getLastActivity());
  updateTimer();
  const tickId = setInterval(updateTimer, 1000);
})();
</script>
{% endblock %}

{% block footer %}
<footer class="site-footer">
  <div class="container text-center small text-muted">
    {% include 'partials/footer.html' %}
  </div>
</footer>
{% endblock %}
