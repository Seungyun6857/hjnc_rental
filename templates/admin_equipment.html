{% extends "base_admin.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  .wrap { max-width: 1200px; margin: 0 auto; }
  .card-elevate { border: 1px solid #e9ecef; box-shadow: 0 4px 18px rgba(0,0,0,.04); border-radius: .75rem; }

  .chip {display:flex;align-items:center;gap:.5rem;padding:.35rem .7rem;border:1px solid #e9ecef;border-radius:999px;background:#fff}
  .chip i{font-size:1rem;opacity:.7}

  .input-icon{position:relative}
  .input-icon .bi{position:absolute;left:.6rem;top:50%;transform:translateY(-50%);opacity:.55}
  .input-icon input{padding-left:2rem}

  .filter-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr)) auto auto;gap:.5rem}
  @media (max-width: 992px){ .filter-row{grid-template-columns:repeat(2,minmax(0,1fr));} }

  .equip-table thead th{
    position: sticky; top: 0; z-index: 1; background:#f8f9fa;
    vertical-align: middle; white-space: nowrap;
  }
  .equip-table tbody td{ vertical-align: middle; }
  .equip-table tbody tr:hover{ background:#fbfcfe; }

  .w-48{width:48px}.w-80{width:80px}.w-120{width:120px}.w-140{width:140px}
  .qty-input{ width:72px; padding:2px 6px; font-size:.9rem; text-align:center; }

  .empty{ color:#6c757d; text-align:center; padding:3rem 1rem; }
  .empty i{ font-size:2rem; opacity:.5; display:block; margin-bottom:.5rem; }

  /* 하단: 페이징 가운데 */
  .bottom-bar{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:1rem; }
  .bottom-bar nav{ justify-self:center; }
</style>

<div class="wrap">

  <!-- 상단 헤더 -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <h3 class="fw-bold mb-0">장비 관리</h3>
      <span class="badge text-bg-light border">v1.0</span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <div class="chip"><i class="bi bi-box"></i><span class="small text-muted">총 장비</span><strong class="ms-1">{{ total_count or 0 }}</strong></div>
      <div class="chip"><i class="bi bi-check2-circle"></i><span class="small text-muted">사용 가능 합계</span><strong class="ms-1">{{ available_qty_sum or 0 }}</strong></div>
      <div class="chip"><i class="bi bi-activity"></i><span class="small text-muted">사용 중 합계</span><strong class="ms-1">{{ inuse_qty_sum or 0 }}</strong></div>
      <a class="btn btn-outline-success btn-sm ms-2"
         href="{{ url_for('export_equipment',
                          name=request.args.get('name'),
                          model=request.args.get('model'),
                          category=request.args.get('category'),
                          location=request.args.get('location'),
                          total_qty=request.args.get('total_qty'),
                          available_qty=request.args.get('available_qty')) }}">
        <i class="bi bi-file-earmark-excel"></i> 엑셀 내보내기
      </a>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAdd">
        <i class="bi bi-plus-lg"></i> 장비 등록
      </button>
    </div>
  </div>

  <!-- 툴바 -->
  <div class="d-flex flex-wrap gap-2 mb-2">
    <button id="btn-bulk-delete" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3"></i> 선택 삭제</button>
    <button id="btn-reset" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-counterclockwise"></i> 초기화</button>
  </div>

  <!-- 필터 + (우측) 페이지당 -->
  <div class="card card-elevate mb-3">
    <div class="card-body py-3">
      <div class="d-flex align-items-start justify-content-between gap-3">
        <!-- 좌: 필터 -->
        <form class="filter-row flex-grow-1" method="get" action="{{ url_for('admin_equipment') }}">
          <div class="input-icon">
            <i class="bi bi-search"></i>
            <input class="form-control" name="name" placeholder="장비 이름" value="{{ request.args.get('name','') }}">
          </div>
          <div class="input-icon">
            <i class="bi bi-cpu"></i>
            <input class="form-control" name="model" placeholder="모델명" value="{{ request.args.get('model','') }}">
          </div>
          <div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-grid"></i></span>
              <select class="form-select" name="category">
                <option value="">카테고리 전체</option>
                <option value="전자 제품" {{ 'selected' if request.args.get('category')=='전자 제품' else '' }}>전자 제품</option>
                <option value="소모품" {{ 'selected' if request.args.get('category')=='소모품' else '' }}>소모품</option>
                <option value="유지보수 제품" {{ 'selected' if request.args.get('category')=='유지보수 제품' else '' }}>유지보수 제품</option>
                <option value="공구" {{ 'selected' if request.args.get('category')=='공구' else '' }}>공구</option>
                <option value="기타" {{ 'selected' if request.args.get('category')=='기타' else '' }}>기타</option>
                <option value="잡자재" {{ 'selected' if request.args.get('category')=='잡자재' else '' }}>잡자재</option>
              </select>
            </div>
          </div>
          <div class="input-icon">
            <i class="bi bi-geo-alt"></i>
            <input class="form-control" name="location" placeholder="위치" value="{{ request.args.get('location','') }}">
          </div>
          <button class="btn btn-dark"><i class="bi bi-search"></i> 검색</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('admin_equipment') }}">초기화</a>
        </form>

        <!-- 우: 페이지 당 -->
        <form method="get" action="{{ url_for('admin_equipment') }}" class="d-flex align-items-center gap-2">
          <!-- 기존 검색조건 유지 -->
          <input type="hidden" name="name" value="{{ request.args.get('name','') }}">
          <input type="hidden" name="model" value="{{ request.args.get('model','') }}">
          <input type="hidden" name="category" value="{{ request.args.get('category','') }}">
          <input type="hidden" name="location" value="{{ request.args.get('location','') }}">
          <label class="small text-muted">페이지 당</label>
          <select name="per_page" class="form-select form-select-sm" onchange="this.form.submit()" style="width:120px">
            <option value="10" {{ 'selected' if per_page==10 else '' }}>10개씩</option>
            <option value="20" {{ 'selected' if per_page==20 else '' }}>20개씩</option>
            <option value="50" {{ 'selected' if per_page==50 else '' }}>50개씩</option>
          </select>
        </form>
      </div>
    </div>
  </div>

  <!-- 테이블 -->
  <div class="card card-elevate">
    <div class="table-responsive">
      <table class="table table-hover equip-table mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center w-48"><input type="checkbox" class="form-check-input" id="check-all"></th>
            <th class="text-center w-80">No</th>
            <th>장비 이름</th>
            <th class="w-120 text-start">모델명</th>
            <th class="w-120">카테고리</th>
            <th class="w-140">위치</th>
            <th class="text-center" style="width:110px">총 수량</th>
            <th class="text-center" style="width:120px">사용 가능</th>
            <th class="text-center w-120">수정</th>
          </tr>
        </thead>
        <tbody>
          {% if equipment_list and equipment_list|length>0 %}
            {% for r in equipment_list %}
            <tr>
              <td class="text-center"><input type="checkbox" class="form-check-input row-check" value="{{ r.id }}"></td>
              <td class="text-center">{{ r.display_no }}</td>
              <td class="fw-semibold">{{ r.item_name }}</td>
              <td class="text-start">{{ r.model_name }}</td>
              <td><span class="badge bg-secondary-subtle text-secondary border">{{ r.category }}</span></td>
              <td>{{ r.location }}</td>
              <td class="text-center">
                <form method="post" action="{{ url_for('update_equipment_quantity') }}" class="d-inline-flex align-items-center gap-2">
                  <input type="hidden" name="equipment_id" value="{{ r.id }}">
                  <input type="number" name="total_qty" class="form-control form-control-sm qty-input" value="{{ r.total_qty }}">
              </td>
              <td class="text-center">
                  <input type="number" name="available_qty" class="form-control form-control-sm qty-input" value="{{ r.available_qty }}">
              </td>
              <td class="text-center">
                  <button class="btn btn-outline-primary btn-sm"><i class="bi bi-save2"></i> 저장</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9">
                <div class="empty">
                  <i class="bi bi-inboxes"></i>
                  등록된 장비가 없습니다. <a href="#" data-bs-toggle="modal" data-bs-target="#modalAdd">장비를 등록</a>해 보세요.
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- 하단: 페이징 가운데 -->
    <div class="p-3 bottom-bar">
      <div></div>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {{ 'disabled' if page<=1 else '' }}">
            <a class="page-link" href="{{ url_for('admin_equipment', page=page-1, per_page=per_page, name=request.args.get('name'), model=request.args.get('model'), category=request.args.get('category'), location=request.args.get('location')) }}">이전</a>
          </li>
          {% for p in range(1, (total_pages or 1)+1) %}
          <li class="page-item {{ 'active' if p==page else '' }}">
            <a class="page-link" href="{{ url_for('admin_equipment', page=p, per_page=per_page, name=request.args.get('name'), model=request.args.get('model'), category=request.args.get('category'), location=request.args.get('location')) }}">{{ p }}</a>
          </li>
          {% endfor %}
          <li class="page-item {{ 'disabled' if page>= (total_pages or 1) else '' }}">
            <a class="page-link" href="{{ url_for('admin_equipment', page=page+1, per_page=per_page, name=request.args.get('name'), model=request.args.get('model'), category=request.args.get('category'), location=request.args.get('location')) }}">다음</a>
          </li>
        </ul>
      </nav>
      <div></div>
    </div>
  </div>
</div>

<!-- 등록 모달 -->
<div class="modal fade" id="modalAdd" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('register_equipment') }}">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-lg me-1"></i> 새 장비 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">장비 이름<span class="text-danger">*</span></label>
              <input name="name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">모델명</label>
              <input name="model" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">카테고리</label>
              <select name="category" class="form-select">
                <option value="">선택</option>
                <option value="전자 제품">전자 제품</option>
                <option value="소모품">소모품</option>
                <option value="유지보수 제품">유지보수 제품</option>
                <option value="공구">공구</option>
                <option value="기타">기타</option>
                <option value="잡자재">잡자재</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">위치</label>
              <input name="location" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label">총 수량</label>
              <input name="total_qty" type="number" class="form-control" value="0" min="0">
            </div>
            <div class="col-md-2">
              <label class="form-label">사용 가능</label>
              <input name="available_qty" type="number" class="form-control" value="0" min="0">
            </div>
            <div class="col-12">
              <label class="form-label">비고</label>
              <textarea name="note" class="form-control" rows="2" placeholder="특이사항/관리 메모"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit"><i class="bi bi-upload"></i> 등록</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 선택 삭제용 숨김 폼 -->
<form id="bulk-delete-form" method="post" action="{{ url_for('delete_equipments') }}" class="d-none"></form>

<script>
  const checkAll = document.getElementById('check-all');
  const rowChecks = () => Array.from(document.querySelectorAll('.row-check'));
  checkAll?.addEventListener('change', e => rowChecks().forEach(c => c.checked = e.target.checked));

  document.getElementById('btn-reset')?.addEventListener('click', ()=>{
    const url = new URL(window.location);
    ['name','model','category','location','page'].forEach(k => url.searchParams.delete(k));
    window.location = url.toString();
  });

  document.getElementById('btn-bulk-delete')?.addEventListener('click', ()=>{
    const ids = rowChecks().filter(c=>c.checked).map(c=>c.value);
    if(ids.length===0){ alert('삭제할 항목을 선택하세요.'); return; }
    if(!confirm(`${ids.length}개 항목을 삭제하시겠습니까?`)) return;
    const f = document.getElementById('bulk-delete-form'); f.innerHTML='';
    ids.forEach(id=>{
      const input=document.createElement('input'); input.type='hidden'; input.name='equipment_ids'; input.value=id; f.appendChild(input);
    });
    f.submit();
  });
</script>
{% endblock %}
