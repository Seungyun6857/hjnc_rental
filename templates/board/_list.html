<div class="card shadow-sm">
  <!-- 카드 헤더는 sticky 제거(겹침 방지) -->
  <div class="card-header bg-white">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <strong>목록</strong>

      <div class="d-flex align-items-center gap-2 ms-auto">
        <button form="bulkDeleteForm" id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm" disabled
                onclick="return confirm('선택한 항목을 삭제할까요?');">
          <i class="bi bi-trash3"></i> 선택 삭제
        </button>

        <form class="d-flex align-items-center gap-2" method="get"
              action="{{ url_for('admin_board_type', board_type=board_type) }}">
          <input type="hidden" name="board_type" value="{{ board_type }}">
          <select name="category" class="form-select form-select-sm" style="width:120px">
            {% for c in categories %}
              <option value="{{ c }}" {{ 'selected' if c==category else '' }}>{{ c if c else '전체' }}</option>
            {% endfor %}
          </select>
          <select name="per_page" class="form-select form-select-sm" style="width:100px" onchange="this.form.submit()">
            <option value="10" {{ 'selected' if per_page==10 else '' }}>10개</option>
            <option value="20" {{ 'selected' if per_page==20 else '' }}>20개</option>
            <option value="50" {{ 'selected' if per_page==50 else '' }}>50개</option>
          </select>
          <div class="input-group input-group-sm" style="width:260px">
            <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="검색어(제목+내용)">
            <button class="btn btn-outline-primary"><i class="bi bi-search"></i></button>
          </div>
          <input type="hidden" name="page" value="1">
        </form>
      </div>
    </div>
  </div>

  <form id="bulkDeleteForm" action="{{ url_for('bulk_delete_board') }}" method="post">
    <input type="hidden" name="q" value="{{ q }}">
    <input type="hidden" name="category" value="{{ category }}">
    <input type="hidden" name="page" value="{{ page }}">
    <input type="hidden" name="per_page" value="{{ per_page }}">
    <input type="hidden" name="board_type" value="{{ board_type }}">

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <!-- ✅ thead만 sticky: 화면 최상단에 고정되어 겹침 없음 -->
        <thead class="table-light sticky-top" style="top:0; z-index:2;">
          <tr>
            <th style="width:56px" class="text-center"><input type="checkbox" id="checkAll"></th>
            <th>제목 / 내용</th>
            <th style="width:180px">구분{% if board_type=='all' %} / 보드{% endif %}</th>
            <th style="width:170px">작성일</th>
            <th style="width:200px" class="text-end">관리</th>
          </tr>
        </thead>
        <tbody>
        {% if posts %}
          {% for p in posts %}
          <tr class="row-hover">
            <td class="text-center">
              <input type="checkbox" class="row-check" name="ids" value="{{ p.id }}">
            </td>
            <td class="text-break">
              {% if p.is_pinned %}<span class="me-1" title="상단 고정">📌</span>{% endif %}
              <a href="#" class="fw-semibold link-body-emphasis text-decoration-none post-link" data-id="{{ p.id }}">{{ p.title }}</a>
              {% if p.content %}<div class="small text-muted text-truncate-2 mt-1">{{ p.content }}</div>{% endif %}
            </td>
            <td>
              {% if board_type == 'all' %}
                <span class="chip me-1 {{ 'active' if p.board_type in ['work','general','data','qna'] else '' }}">
                  <i class="bi {{ {
                        'work':'bi-briefcase',
                        'general':'bi-chat-text',
                        'data':'bi-folder2-open',
                        'qna':'bi-question-circle'
                      }.get(p.board_type, 'bi-grid') }}"></i>
                  {{ {'work':'업무','general':'일반','data':'자료','qna':'Q&A'}.get(p.board_type,'기타') }}
                </span>
              {% endif %}
              <span class="badge-cat
                {% if p.category == '공지' %}badge-notice
                {% elif p.category == '안내' %}badge-info
                {% elif p.category == '점검' %}badge-danger
                {% else %}badge-etc{% endif %}">{{ p.category or '기타' }}</span>
            </td>
            <td class="text-muted small">{{ p.created_at[:16] }}</td>
            <td class="text-end">
              <form action="{{ url_for('toggle_pin', post_id=p.id, board_type=board_type, q=q, category=category, page=page, per_page=per_page) }}" method="post" class="d-inline">
                <button class="btn btn-outline-secondary btn-sm">
                  {% if p.is_pinned %}<i class="bi bi-pin-angle"></i> 고정해제{% else %}<i class="bi bi-pin"></i> 고정{% endif %}
                </button>
              </form>
              <form action="{{ url_for('delete_board_post', post_id=p.id, board_type=board_type, q=q, category=category, page=page, per_page=per_page) }}"
                    method="post" class="d-inline" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                <button class="btn btn-danger btn-sm ms-1"><i class="bi bi-trash3"></i> 삭제</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="py-5">
              <div class="text-center text-muted">
                <div class="empty-illust mb-2">🗂️</div>
                <div class="fw-semibold">등록된 게시글이 없습니다.</div>
                <div class="small">상단의 폼에서 새 글을 등록해 보세요.</div>
              </div>
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </form>
</div>

<!-- 페이징 -->
<nav class="mt-3">
  <ul class="pagination justify-content-center mb-0">
    <li class="page-item {{ 'disabled' if page <= 1 }}">
      <a class="page-link" href="{{ url_for('admin_board_type', board_type=board_type, page=page-1, per_page=per_page, q=q, category=category) }}">이전</a>
    </li>

    {% set start = 1 if page-2 < 1 else page-2 %}
    {% set end = total_pages if page+2 > total_pages else page+2 %}

    {% if start > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('admin_board_type', board_type=board_type, page=1, per_page=per_page, q=q, category=category) }}">1</a>
      </li>
      {% if start > 2 %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
    {% endif %}

    {% for p in range(start, end+1) %}
      <li class="page-item {{ 'active' if p==page else '' }}">
        <a class="page-link" href="{{ url_for('admin_board_type', board_type=board_type, page=p, per_page=per_page, q=q, category=category) }}">{{ p }}</a>
      </li>
    {% endfor %}

    {% if end < total_pages %}
      {% if end < total_pages-1 %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('admin_board_type', board_type=board_type, page=total_pages, per_page=per_page, q=q, category=category) }}">{{ total_pages }}</a>
      </li>
    {% endif %}

    <li class="page-item {{ 'disabled' if page >= total_pages }}">
      <a class="page-link" href="{{ url_for('admin_board_type', board_type=board_type, page=page+1, per_page=per_page, q=q, category=category) }}">다음</a>
    </li>
  </ul>
  <p class="text-center text-muted small mt-2">총 {{ total }}건 · {{ page }}/{{ total_pages }} 페이지</p>
</nav>

<script>
  // 체크박스/일괄삭제
  const checkAll = document.getElementById('checkAll');
  const rowChecks = document.querySelectorAll('.row-check');
  const bulkBtn = document.getElementById('bulkDeleteBtn');
  function refreshBulkBtn(){ bulkBtn.disabled = ![...rowChecks].some(ch=>ch.checked); }
  checkAll?.addEventListener('change', () => { rowChecks.forEach(ch => ch.checked = checkAll.checked); refreshBulkBtn(); });
  rowChecks.forEach(ch => ch.addEventListener('change', () => { if(!ch.checked) checkAll.checked=false; refreshBulkBtn(); }));

  // 상세/수정 모달
  document.querySelectorAll('.post-link').forEach(el=>{
    el.addEventListener('click', async (e)=>{
      e.preventDefault();
      const id = el.dataset.id;
      try{
        const res = await fetch(`/admin/board/${id}`);
        if(!res.ok) throw new Error();
        const d = await res.json();

        fTitle.value   = d.title || '';
        fContent.value = d.content || '';
        fCategory.value= d.category || '안내';
        fPinned.checked= !!d.is_pinned;

        postModalBadge.textContent = d.category || '안내';
        postModalBadge.className = 'badge ' + (
          d.category === '공지' ? 'bg-warning text-dark' :
          d.category === '안내' ? 'bg-info text-dark' :
          d.category === '점검' ? 'bg-danger' : 'bg-secondary'
        );
        postModalMeta.textContent = (d.is_pinned ? '상단 고정 · ' : '') + (d.created_at || '');

        const params = new URLSearchParams({
          q: "{{ q }}", category: "{{ category }}", page: "{{ page }}",
          per_page: "{{ per_page }}", board_type: "{{ board_type }}"
        }).toString();
        editForm.action = `/admin/board/update/${id}?${params}`;

        setEditMode(false);
        new bootstrap.Modal(document.getElementById('postModal')).show();
      }catch(e){ alert('게시글을 불러오지 못했습니다.'); }
    });
  });
</script>
