{% extends "base_admin.html" %}
{% block content %}
<div class="container-fluid">
  <h4 class="mb-4"><i class="fas fa-undo me-2"></i>반납 현황</h4>

  <!-- 삭제 폼 -->
  <form method="POST" action="{{ url_for('delete_returns') }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <button type="button" class="btn btn-outline-primary btn-sm me-2" id="select-all">전체 선택</button>
        <button type="submit" class="btn btn-outline-danger btn-sm">
          삭제
        </button>
      </div>
      <div class="d-flex align-items-center">
        <input type="text" id="searchInput" class="form-control form-control-sm me-2"
               placeholder="장비 번호 또는 Unit No 검색" style="width: 260px">
        <select id="itemCount" class="form-select form-select-sm" style="width: auto">
          <option value="10">10개씩 보기</option>
          <option value="20">20개씩 보기</option>
          <option value="30">30개씩 보기</option>
        </select>
      </div>
    </div>

    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-light">
        <tr>
          <th style="width: 40px;"><input type="checkbox" id="checkAll" aria-label="전체 선택"></th>
          <th>사용자명</th>
          <th>부서</th>
          <th>전화번호</th>
          <th>장비 번호</th>
          <th>Unit No</th>
          <th>대여일</th>
          <th>반납일</th>
        </tr>
      </thead>
      <tbody id="returnTable">
        {% if return_list and return_list|length > 0 %}
          {% for rental in return_list %}
          <tr>
            <!-- rental[0] = id (PK) -->
            <td><input type="checkbox" class="row-check" name="ids" value="{{ rental[0] }}"></td>
            <td>{{ rental[1] }}</td>  <!-- 사용자명 -->
            <td>{{ rental[2] }}</td>  <!-- 부서 -->
            <td>{{ rental[3] }}</td>  <!-- 전화번호 -->
            <td>{{ rental[4] }}</td>  <!-- 장비 번호 -->
            <td>{{ rental[5] or 'None' }}</td>  <!-- Unit No -->
            <td>{{ rental[6] }}</td>  <!-- 대여일 -->
            <td>{{ rental[7] }}</td>  <!-- 반납일 -->
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8">반납 내역이 없습니다.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <!-- 페이징 -->
    <div class="d-flex justify-content-center mt-3">
      <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="prevPage">이전</button>
      <span id="pageInfo" class="align-self-center small text-muted"></span>
      <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="nextPage">다음</button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // 전체 선택 체크박스
  const checkAll = document.getElementById('checkAll');
  if (checkAll) {
    checkAll.addEventListener('change', function () {
      const isChecked = this.checked;
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.checked = isChecked;
        cb.closest('tr').classList.toggle('table-active', isChecked);
      });
    });
  }

  // 개별 체크 → 행 하이라이트
  document.querySelectorAll('.row-check').forEach(cb => {
    cb.addEventListener('change', function () {
      this.closest('tr').classList.toggle('table-active', this.checked);
    });
  });

  // '전체 선택' 버튼
  const selectAllBtn = document.getElementById('select-all');
  if (selectAllBtn) {
    selectAllBtn.addEventListener('click', function () {
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.checked = true;
        cb.closest('tr').classList.add('table-active');
      });
      if (checkAll) checkAll.checked = true;
    });
  }

  // 페이징/검색
  const rows = Array.from(document.querySelectorAll('#returnTable tr'));
  const itemCountSelect = document.getElementById('itemCount');
  const pageInfo = document.getElementById('pageInfo');
  const searchInput = document.getElementById('searchInput');

  let currentPage = 1;
  let itemsPerPage = parseInt(itemCountSelect.value || '10', 10);

  function filterRows() {
    const q = (searchInput?.value || '').toLowerCase();
    return rows.filter(row => {
      const serial = (row.cells[4]?.innerText || '').toLowerCase(); // 장비번호
      const unit   = (row.cells[5]?.innerText || '').toLowerCase(); // Unit No
      return serial.includes(q) || unit.includes(q);
    });
  }

  function showPage(page) {
    const filtered = filterRows();
    rows.forEach(r => r.style.display = 'none');

    const totalPages = Math.max(Math.ceil(filtered.length / itemsPerPage), 1);
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;

    const start = (page - 1) * itemsPerPage;
    const end   = start + itemsPerPage;
    filtered.slice(start, end).forEach(r => r.style.display = '');

    pageInfo.textContent = `페이지 ${page} / ${totalPages}`;
    currentPage = page;
  }

  document.getElementById('prevPage')?.addEventListener('click', () => showPage(currentPage - 1));
  document.getElementById('nextPage')?.addEventListener('click', () => showPage(currentPage + 1));
  itemCountSelect?.addEventListener('change', () => {
    itemsPerPage = parseInt(itemCountSelect.value || '10', 10);
    showPage(1);
  });
  searchInput?.addEventListener('input', () => showPage(1));

  // 초기 렌더
  showPage(1);
});
</script>
{% endblock %}
